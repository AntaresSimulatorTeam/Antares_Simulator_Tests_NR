name: Archive generation

on:
  release:
    types: [created]

env:
  GITHUB_TOKEN: ${{ github.token }}

jobs:
    read_batches:
      runs-on: ubuntu-latest
      outputs:
        batches: ${{ steps.read_batches.outputs.batches }}
      steps:
        - name: Checkout self
          uses: actions/checkout@v2

        - name: Read study-batches.txt
          id: read_batches
          run: |
            BATCHES=$(printf "%s," $(cat study-batches.txt) | sed "s/^/[/;s/,$/]/")
            echo "::set-output name=batches::$BATCHES"

        - name: Get release
          id: get_release
          uses: bruceadams/get-release@v1.2.3

        - name: Upload study-batches.txt
          uses: actions/upload-release-asset@v1.0.2
          with:
            upload_url: ${{ steps.get_release.outputs.upload_url }}
            asset_path: study-batches.txt
            asset_name: study-batches.txt
            asset_content_type: application/octet-stream


    main:
      runs-on: ubuntu-latest
      needs: read_batches
      strategy:
        matrix:
          batch: ${{ needs.read_batches.outputs.batches }}

      steps:
        - name: Get release
          id: get_release
          uses: bruceadams/get-release@v1.2.3

        - name: Checkout self
          uses: actions/checkout@v2

        - name: zip directory
          run: zip -r output.zip ${{ matrix.batch }}

        - name: Upload .zip
          uses: actions/upload-release-asset@v1.0.2
          with:
            upload_url: ${{ steps.get_release.outputs.upload_url }}
            asset_path: output.zip
            asset_name: ${{ matrix.batch }}.zip
            asset_content_type: application/octet-stream
